<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en" class="no-js"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en" class="no-js"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en" class="no-js"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en" class="no-js"> <!--<![endif]-->

<head>
	<meta charset="utf-8">
	<title>Ken Egozi | Web builder</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="description" content="Ken Egozi's homepage">
	<meta name="author" content="Ken Egozi">
	<meta content="Ken Egozi's homepage" property='og:description'>
	<meta content='summary' name='twitter:card'>
	<meta content='@kenegozi' name='twitter:site'>
	<meta content='Ken Egozi | Web builder' property='og:title'>
	
	<link rel="canonical" href="http://kenegozi.com/blog/tag/hql/index.html" />

	<link rel="stylesheet" href="/assets/stylesheets/bootstrap.css" />
	<link rel="stylesheet" href="/assets/stylesheets/main.css" />

	<!-- Google Fonts -->
	<link href='http://fonts.googleapis.com/css?family=Dosis:300,400,500,600,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,300,400,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700' rel='stylesheet' type='text/css'>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type='text/css'>

	<!-- IE 9 Fallback-->
	<!--[if IE 9]>
		<link href="/assets/css/ie.css" rel="stylesheet">
	<![endif]-->

	<!-- HTML5 shim, for IE6-8 support of HTML5 elements and IE Fallback-->
	<!--[if lt IE 9]>
	  <script src="/assets/js/html5shiv.js"></script>
	<![endif]-->

	<!-- Fav and touch icons -->
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-57-precomposed.png">
	<link rel="shortcut icon" href="/assets/img/favicon.ico">
</head>
<body id="top" class="">
	
	<!-- NAVBAR -->
	<div class="navbar navbar-fixed-top navbar-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-nav">
					<span class="sr-only">Menu</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<nav class="navbar-collapse collapse" id="main-nav" role="navigation">
				<ul class="nav navbar-nav navbar-right">
					
					<li><a href="/">home</a></li>
					<li><a href="/#about">about</a></li>
					<li><a href="/#blog">blog</a></li>
					<li><a href="/#contact">contact</a></li>
				</ul>
			</nav>
		</div>
	</div>
	<!-- END NAVBAR -->
<section class="container content tags">
  <h1 class="post_title">Posts Tagged &ldquo;hql&rdquo;</h1>
  <div class="post-sidebar">
	<h5>Follow</h5>
	<p>
		<a href="http://feeds2.feedburner.com/kenegozi">
			<img src="http://feeds.feedburner.com/~fc/kenegozi?bg=000033&amp;fg=00FF00&amp;anim=1" height="26" width="88" style="border:0" alt="">
		</a>
	</p>
	<hr/>
</div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/10/02/happy-new-year-here-comes-sql">Happy new year, here comes SQL</a></h2>
    <div class="meta">
        <time>on October 2, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/nhibernate" rel="tag">nhibernate</a>
            ,&nbsp;
            
            <a href="/blog/tag/hql" rel="tag">hql</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>One of the things occupying me is my work on my last seminar for the university, so I’d finally get my Bachelor’s degree.</p>

<p>The project is building an application for managing, uhm, a university. You reckon they figured out a way to prototype a new system for free … ?</p>

<p>Anyway, the seminar name is “Database Management Systems Workshop”, so one of the things I have to do is to present a full E/R-D even before I start coding. And UI design sheets. So no agile here :(</p>

<p>My aim is to be able to demonstrate some cool stuff though, like the usage of an advanced O/R mapper (NH), static and dynamic object-based querying (hql and Criteria API), some advanced T-SQL stuff (<a href="http://www.setfocus.com/TechnicalArticles/sql-server-2005-tsql-3.aspx">recursive set-based queries using CTE</a>, and some <a href="http://kenegozi.com/Blog/2008/07/28/unique-when-not-null-or-not-empty-in-sql-server.aspx">fancy integrity enforcing triggers</a>), smart caching with <a href="http://davidhayden.com/blog/dave/archive/2006/04/29/2929.aspx">SqlCacheDependency</a>, and more.</p>

<p>To make things interesting I decided to create a large-ish mount of fake data. Well, at least in terms of a non-production university-demo app. My DB currently holds 600K students and over 500 possible modules.</p>

<p>I’ll blog a bit on the ways I used to populate that data, and other data as well (such as the ModulePrerequisites table which is an adjacency table).</p>

<p>So, beware, some SQL might follow</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/09/12/get-unique-results-from-joined-queries-in-nhibernate">Get unique results from joined queries in NHibernate</a></h2>
    <div class="meta">
        <time>on September 12, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/nhibernate" rel="tag">nhibernate</a>
            ,&nbsp;
            
            <a href="/blog/tag/hql" rel="tag">hql</a>
            
            
        </span>
        
    </div>
    
     <p>I’ve just added a page to <a href="http://www.nhforge.org/">NHibernate’s new community site</a>, about <a href="http://www.nhforge.org/wikis/howtonh/get-unique-results-from-joined-queries.aspx">Getting unique results from joined queries</a>.</p>

<p>Comments (and edits) are welcome</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/05/09/using-nhibernates-named-queries-with-activerecord">Using nhibernate's named queries with ActiveRecord</a></h2>
    <div class="meta">
        <time>on May 9, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/castle" rel="tag">castle</a>
            ,&nbsp;
            
            <a href="/blog/tag/activerecord" rel="tag">activerecord</a>
            ,&nbsp;
            
            <a href="/blog/tag/nhibernate" rel="tag">nhibernate</a>
            ,&nbsp;
            
            <a href="/blog/tag/hql" rel="tag">hql</a>
            
            
        </span>
        
    </div>
    
     <p>One of the methods of querying the DB when using NHibernate, is to issue <a href="http://www.hibernate.org/hib_docs/reference/en/html/queryhql.html">HQL</a> queries. HQL stands for “Hibernate Query Language”. It has a SQL-like syntax and is very intuitive for people with SQL background.</p>

<p>The way this works is that NHibernate ‘compiles’ the HQL query into SQL, and then issues the SQL query (using ADO.NET’s facilities) to the DB.</p>

<p>Sounds pricey?</p>

<p>enter Named Queries.</p>

<p>now these are HQL (or SQL) queries, each has a name (obviously), that are been supplied to NH through the mapping. The queries are being translated and cached as IDbCommand objects as part of the framework initialisation, which mean that you get rid of the HQL-&gt;SQL overhead throughout the life of the process.</p>

<p>One other major benefit, is that the mechanism to actually execute these named queries, does not differentiate between HQL and SQL queries (for the simple fact that these queries have already been transferred to SQL at runtime). That gives you the possibility to replace HQL queries into tighter SQL queries (with the same parameters and which returns the same resultset) should your DBA figure out a better one.</p>

<p>But if you’re using ActiveRecord, you usually do not have direct access into the mapping (.hbm) files. So how would you use named queries with AR?</p>

<p>enter HqlNamedQueryAttribute (not such a great name, as I did state that it would also work for SQL queries).</p>

<p>So, for an example, on this blog’s source code, within PostRepository.cs you’d see this code:</p>

<p>```</p>

<p>…</p>

<h1 id="region-queriesassembly-hqlnamedqueryqueriesfindpostsinarchive-queriesfindpostsinarchiveassembly-hqlnamedqueryqueriesfindbyurlfriendlytagname-queriesfindbyurlfriendlytagnamenamespace-kenegozicomdomain-internal-partial-class-queries--internal-const-string-findpostsinarchive---from-post-p-where--yearplifecyclecreationdate--year-and-monthplifecyclecreationdate--month--order-by-plifecyclecreationdate-desc-internal-const-string-findbyurlfriendlytagname---select-p--from--post-p--join-ptags-t-where-turlfriendlyname-like-urlfriendlytagname-order-by-plifecyclecreationdate-desc-endregion">region queries[assembly: HqlNamedQuery(Queries.FindPostsInArchive, Queries.FindPostsInArchive)][assembly: HqlNamedQuery(Queries.FindByUrlFriendlyTagName, Queries.FindByUrlFriendlyTagName)]namespace KenEgozi.Com.Domain{ internal partial class Queries { internal const string FindPostsInArchive = @” from Post p where  year(p.Lifecycle.CreationDate) = :year and month(p.Lifecycle.CreationDate) = :month  order by p.Lifecycle.CreationDate desc”; internal const string FindByUrlFriendlyTagName = @” select p  from  Post p  join p.Tags t where t.UrlFriendlyName like :urlFriendlyTagName order by p.Lifecycle.CreationDate desc;”; }}#endregion</h1>

<p>…</p>

<p>public ICollection<post> FindInArchive(int year, int month) { </post></p>

<p>return session .GetNamedQuery(Queries.FindPostsInArchive) .SetParameter(“year”, year) .SetParameter(“month”, month) .List<post>(); }</post></p>

<p>…</p>

<p>```</p>

<p>Queries class is marked as partial, as other queries might be presented on other repositories or services that would need to add more named queries. I considered grouping of queries into groups by the using repository, or by aggregate roots, but the thing is - having all of the queries under the same namespace helps discoverability, and helps with preventing duplications</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2007/07/06/summing-up-the-last-two-and-a-half-years-bye-bye-sqlink">Summing up the last two and a half years - Bye bye SQLink</a></h2>
    <div class="meta">
        <time>on July 6, 2007</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/castle" rel="tag">castle</a>
            ,&nbsp;
            
            <a href="/blog/tag/activerecord" rel="tag">activerecord</a>
            ,&nbsp;
            
            <a href="/blog/tag/aspview" rel="tag">aspview</a>
            ,&nbsp;
            
            <a href="/blog/tag/hql" rel="tag">hql</a>
            ,&nbsp;
            
            <a href="/blog/tag/personal" rel="tag">personal</a>
            
            
        </span>
        
    </div>
    
     <p>It was absolutely brilliant.</p>

<p>I started to work for SQLink on late December 2005 as a Team Leader in the Web Projects Department.</p>

<p>Colleaged by <a href="http://www.lnbogen.com">Oren Ellenbogen</a>, it has been a pleasure. Our department head, Moti, was doing the best he can to create a very likeable working environment, and all our developers were enjoing a workplace that enabled them to learn a lot. Oren and I were directing all kinds of sessions with the developers, showing them stuff about .NET and the CLR, from “what are nullables”, through “What does the ‘using’ reserved word mean”, to “how the GC is actually working”.</p>

<p>We have built this great website called <a href="http://www.gotfriends.co.il">GotFriends</a>, that gave the company a great new source for recruiting new employees, and actually is ground breaking in the Israeli HR world. Building that site, we’ve used many technologies to make it work smoothly with the company’s inner legacy HR system, and with the aid of the SQL master Moran Benisty, it even worked in an efficient way, and coded in a maintainable manner.</p>

<p>Mixing WebForms and Monorail, CodeSmith based BLL with ActiveRecord/NH, ASP.NET WebServices (asmx) and POX/JSON services, it was a very fun thing to work on, in addition to the business benefit to the company.</p>

<p>However, a few months ago the Web Project Department was closed, and the company started a new R&amp;D team, leadedby Elad, the company’s VP of Business Development. We were two developers (Moran and I), and we worked on several initiatives that the CEO Tamir, and Elad, were cooking all the time. Those projects wereall Community-Driven-So-Called-Web-2.0-Kinda-Websites. It was a real delight, and I got the chance to learn a lot about the business side of running an Internet related initiative, as both Tamir and Elad are experienced and intelligent, and the process of refining ideas, with those two, was a real treat.</p>

<p>They also gave me the freedom to make all the technology decisions, and they’ve had enough faith in me to allow me run the projects using MonoRail and AspView, and running Castle ActiveRecord for DB access. Actually, most of the drive behind creating AspView was actually driven by Elad and Tamir, as I’ve promised to do the best I can to make sure that future additions to the team won’t need to learn Boo / Velocity in addition to learn the Monorail MVC and hql. </p>

<p>Which actually worked great. Moran has left the team about two months ago, and we’ve brought three new guys along (Ili, Ofir and last but not least, Itay), and they have seam to easily get control of all the “funky” technologies I’ve put in use in our projects.</p>

<p>Sadly enough, one of the initiatives has stalled just before airing, due to some business decisions. Then we started a new one, and in about 3 weeks we’ve had a working proof-of-concept, and I really hope that the site will air during August. I give the credit to the team, and to the use of MonoRail/ActiveRecord, as it’s such agile and suits highly-changing-environment, as most web initiatives are.</p>

<p>A point of interest: This very blog’s engine was actually a beta testing for some of the stuff we were using on our last project.</p>

<p>That’s it folks. I wish the SQLink family all the best, and I’m going to keep an eye on the cool stuff the R&amp;D team is doing, and hopefully I’ll report on their success (which would be an AspView success too …) right here on my blog.</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2007/01/04/nhibernate-could-not-find-constructor-for-in-select-new-projection-query">NHibernate ' Could not find constructor for: ' in ' select new ' projection query</a></h2>
    <div class="meta">
        <time>on January 4, 2007</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/castle" rel="tag">castle</a>
            ,&nbsp;
            
            <a href="/blog/tag/activerecord" rel="tag">activerecord</a>
            ,&nbsp;
            
            <a href="/blog/tag/nhibernate" rel="tag">nhibernate</a>
            ,&nbsp;
            
            <a href="/blog/tag/hql" rel="tag">hql</a>
            
            
        </span>
        
    </div>
    
     <p>There are two facts here:1. I love NHibernate.2. I hate NHibernate’s exception messages.</p>

<p>And here’s my story.</p>

<p>On a project I’m working on, I need to show a projection of “top 10” from the database. let’s show this on the good old Blog scenario:<img src="http://kenegozi.com/blog/uploaded/WindowsLiveWriter/NHibernateCouldnotfindconstructorforinse_A7E6/Post-Comment-Stupid_erd_thumb%5B2%5D.gif" alt="" /></p>

<p>So I want to show the posts with the longest comments measured by the comment’s length. Stupid, huh? but it’s a demo only (I cannot expose the actual ERD). Let’s say I want the top 5.</p>

<p>I am using Castle ActiveRecord. There is a Post and a Comment classes. However, I do not wish to load Posts objects, since It will load the Comments, too, and maybe other stuff that the Post class is related to. So I have defined a PostProjection class: </p>

<p><code>
   1:  publicclass PostProjection
</code></p>

<p><code>
   2:  {
</code></p>

<p><code>
   3:  publicstring Title;
</code></p>

<p><code>
   4:  publicint Length;
</code></p>

<p><code>
   5:  public PostProjection(string title, int length)
</code></p>

<p><code>
   6:      {
</code></p>

<p><code>
   7:          Title = title;
</code></p>

<p><code>
   8:          Length = length;
</code></p>

<p><code>
   9:      }
</code></p>

<p><code>
  10:  }
</code></p>

<p>I have also added an [Import] attribute on the Post. The actual querying is done using the next hql:</p>

<p><code>
   1:  publicstatic PostProjection[] GetTopPosts(int postsToGet)
</code></p>

<p><code>
   2:  {
</code></p>

<p><code>
   3:      SimpleQuery&lt;PostProjection&gt; q =
</code></p>

<p><code>
   4:  new SimpleQuery&lt;PostProjection&gt;(typeof(Post), @"
</code></p>

<p><code>
   5:          select new PostProjection(p.Title, sum(c.LineCount)) 
</code></p>

<p><code>
   6:          from 
</code></p>

<p><code>
   7:              Post p inner join 
</code></p>

<p><code>
   8:              p.Comments c 
</code></p>

<p><code>
   9:          order by sum(o.LineCount) desc
</code></p>

<p><code>
  10:          group by p.Title");
</code></p>

<p><code>
  11:      q.SetQueryRange(postsToGet);
</code></p>

<p><code>
  12:  return q.Execute();
</code></p>

<p><code>
  13:  }
</code></p>

<p>It worked great.</p>

<p>Yesterday I’ve upgraded my Castle dll’s to the ones from build 229. It includes NHibernate 1.2.0.2002</p>

<p>Now the “select new” started to fail, and NHibernate started to claim than “Could not find constructor for: PostProjection”.</p>

<p>I’ve been scratching my head, trying various approaches, and even was keen to skip the “new” and use an object[ ] and populate the Projection Array by hand, but then I tried changing the “length” parameter of the constructor from “int” to “long”. Magically it solved the problem.</p>

<p>Now, if only NHibernate would have said :</p>

<p>Could not find constructor for: PostProjection.Looking for: PostProjection(string, long)</p>

<p>I would’ve known what the problem was, and what should I change.</p>

<p>So what have we learned today?</p>

<ol>
  <li>NHibernate expects sum() to return “long” rather than “int”2. NHibernate’s error messages suck.</li>
</ol>

<p>I’ve svn-ed the NHibernate trunk, added some code so this message would be more developer friendly, and I’m going to send the patch to NHibernate’s JIRA.</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
</section>


	<!-- FOOTER -->
	<footer id="footer" class="section">
		<div class="container">
			<p class="copyright pull-left">
				&copy; 2014. Ken Egozi. All Rights Reserved.
				<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
					<img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
				</a>
				</p>
		</div>
	</footer>
	<!-- END FOOTER -->
	<div class="back-to-top">
		<a href="#top"><i class="fa fa-chevron-up"></i></a>
	</div>

	<script src="/assets/javascripts/jquery-2.1.0.min.js"></script>
	<script src="/assets/javascripts/jquery.localScroll.min.js"></script>
	<script src="/assets/javascripts/looper.min.js"></script>
	<script src="/assets/javascripts/bootstrap.min.js"></script>
	<script src="/assets/javascripts/site.js"></script>
</body>
</html>

<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en" class="no-js"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en" class="no-js"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en" class="no-js"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en" class="no-js"> <!--<![endif]-->

<head>
	<meta charset="utf-8">
	<title>Ken Egozi | Web builder</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="description" content="Ken Egozi's homepage">
	<meta name="author" content="Ken Egozi">
	<meta content="Ken Egozi's homepage" property='og:description'>
	<meta content='summary' name='twitter:card'>
	<meta content='@kenegozi' name='twitter:site'>
	<meta content='Ken Egozi | Web builder' property='og:title'>
	
	<link rel="canonical" href="http://kenegozi.com/blog/tag/sql/index.html" />

	<link rel="stylesheet" href="/assets/stylesheets/bootstrap.css" />
	<link rel="stylesheet" href="/assets/stylesheets/main.css" />

	<!-- Google Fonts -->
	<link href='http://fonts.googleapis.com/css?family=Dosis:300,400,500,600,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,300,400,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700' rel='stylesheet' type='text/css'>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type='text/css'>

	<!-- IE 9 Fallback-->
	<!--[if IE 9]>
		<link href="/assets/css/ie.css" rel="stylesheet">
	<![endif]-->

	<!-- HTML5 shim, for IE6-8 support of HTML5 elements and IE Fallback-->
	<!--[if lt IE 9]>
	  <script src="/assets/js/html5shiv.js"></script>
	<![endif]-->

	<!-- Fav and touch icons -->
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-57-precomposed.png">
	<link rel="shortcut icon" href="/assets/img/favicon.ico">
</head>
<body id="top" class="">
	
	<!-- NAVBAR -->
	<div class="navbar navbar-fixed-top navbar-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-nav">
					<span class="sr-only">Menu</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<nav class="navbar-collapse collapse" id="main-nav" role="navigation">
				<ul class="nav navbar-nav navbar-right">
					
					<li><a href="/">home</a></li>
					<li><a href="/#about">about</a></li>
					<li><a href="/#blog">blog</a></li>
					<li><a href="/#contact">contact</a></li>
				</ul>
			</nav>
		</div>
	</div>
	<!-- END NAVBAR -->
<section class="container content tags">
  <h1 class="post_title">Posts Tagged &ldquo;sql&rdquo;</h1>
  <div class="post-sidebar">
	<h5>Follow</h5>
	<p>
		<a href="http://feeds2.feedburner.com/kenegozi">
			<img src="http://feeds.feedburner.com/~fc/kenegozi?bg=000033&amp;fg=00FF00&amp;anim=1" height="26" width="88" style="border:0" alt="">
		</a>
	</p>
	<hr/>
</div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2011/11/01/determining-sql-server-edition">Determining SQL Server edition</a></h2>
    <div class="meta">
        <time>on November 1, 2011</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Thanks to <a href="http://support.microsoft.com/kb/321185">http://support.microsoft.com/kb/321185</a> and to Ariel (<a href="https://twitter.com/#!/q">@Q</a>) who have read it more carefully than I did, I learnt that there is a SERVERPROPERTY that you can query:</p>

<p><code>
SELECT SERVERPROPERTY ('edition')
</code></p>

<p>I expected to find Developer, but found Express instead.</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/10/02/happy-new-year-here-comes-sql">Happy new year, here comes SQL</a></h2>
    <div class="meta">
        <time>on October 2, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/nhibernate" rel="tag">nhibernate</a>
            ,&nbsp;
            
            <a href="/blog/tag/hql" rel="tag">hql</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>One of the things occupying me is my work on my last seminar for the university, so I’d finally get my Bachelor’s degree.</p>

<p>The project is building an application for managing, uhm, a university. You reckon they figured out a way to prototype a new system for free … ?</p>

<p>Anyway, the seminar name is “Database Management Systems Workshop”, so one of the things I have to do is to present a full E/R-D even before I start coding. And UI design sheets. So no agile here :(</p>

<p>My aim is to be able to demonstrate some cool stuff though, like the usage of an advanced O/R mapper (NH), static and dynamic object-based querying (hql and Criteria API), some advanced T-SQL stuff (<a href="http://www.setfocus.com/TechnicalArticles/sql-server-2005-tsql-3.aspx">recursive set-based queries using CTE</a>, and some <a href="http://kenegozi.com/Blog/2008/07/28/unique-when-not-null-or-not-empty-in-sql-server.aspx">fancy integrity enforcing triggers</a>), smart caching with <a href="http://davidhayden.com/blog/dave/archive/2006/04/29/2929.aspx">SqlCacheDependency</a>, and more.</p>

<p>To make things interesting I decided to create a large-ish mount of fake data. Well, at least in terms of a non-production university-demo app. My DB currently holds 600K students and over 500 possible modules.</p>

<p>I’ll blog a bit on the ways I used to populate that data, and other data as well (such as the ModulePrerequisites table which is an adjacency table).</p>

<p>So, beware, some SQL might follow</p>


    </section>


  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/10/02/fake-data-for-people-table">Fake data for People table</a></h2>
    <div class="meta">
        <time>on October 2, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Task
Populate People table with fake data for demo purposes.</p>

<p>Assume the relevant tables look like that:</p>

<p><code>
People (Id, LastName, FirstName, CityId)
Cities (Id, Name)
</code></p>

<p>Step 1 - getting names
I created a database called Useful, with two tables: FirstNames and LastNames.</p>

<p>Filled each with first and last names, that I found off sites in the internet.</p>

<p>I managed to get 808 first names, and 742 last names.</p>

<p>Step 2 - generating the data
I wanted to fill the People table with the Cartesian Product of both name tables.</p>

<p>Out of 808 first names and 742 last names I’d get 599,536 rows using </p>

<p><code>
SELECT
    f.Name AS FirstName,
    l.Name AS LastName
FROM
    FirstNames f,
    LastNames l
</code></p>

<p>But I’d also like to have the CityId populated, with a random city.</p>

<p>The naive approach is</p>

<p><code>
SELECT
    f.Name AS FirstName,
    l.Name AS LastName,
    (SELECT TOP 1 Id FROM City ORDER BY NEWID()) AS CityId
FROM
    FirstNames f,
    LastNames l
</code></p>

<p>But the ORDER BY NEWID() bit is happening once for the whole select, so you end up with the same CityId for all you rows.</p>

<p>My end solution was:</p>

<p>```</p>

<p>INSERT INTO People (FirstName, LastName, CityId)</p>

<p>SELECT
    FirstName,
    LastName,
    CityId
FROM
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY l.Name, f.Name) AS ROW,
            f.Name AS FirstName,
            l.Name AS LastName
        FROM
            Useful.dbo.LastNames l,
            Useful.dbo.FirstNames f
    ) AllNames,
    (
        SELECT
            Id AS CityId,
            ROW_NUMBER() OVER (ORDER BY NEWID()) AS ROW
        FROM
            Cities
    ) C
WHERE 
    AllNames.ROW % 66 = C.ROW % 66</p>

<p>```</p>

<p>Let’s go over it:</p>

<ol>
  <li>
    <p>I add a ROW column to the “all names” temp-table. Due to the ORDER BY NEWID()) I’ll get a new sort on every select, so the ROW column is random enough.</p>
  </li>
  <li>
    <p>I add a ROW column to the Cities table. Same kind of randomness as 1</p>
  </li>
</ol>

<p>Now I inner join the tables on the ROW column on both tables, mod the number of possible cities (which is less than the names count), getting a random CityId for each row in the “all names” table (which is the Cartesian Product of FirstNames and LastNames)</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/07/28/unique-when-not-null-or-not-empty-in-sql-server">Unique when not null (or not empty) in SQL Server</a></h2>
    <div class="meta">
        <time>on July 28, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>In SQL Server, you have two main types of Indexes, one that allow duplications, and one that does not.</p>

<p>However, if you want a rule like “I want to forbid duplications, except for null values” you do not have a built in feature for that, as the unique index will treat the NULL value as a real value, thus allowing up to a single row with that NULL.</p>

<p>Apart from refactoring the DB schema, the solution I usually was doing has been to create a trigger to deal with that:</p>

<p><code>
CREATE TRIGGER dbo.People_Unique_NonNull_Email ON dbo.People AFTER INSERTAS BEGIN SET NOCOUNT ON DECLARE @Count INT SELECT @Count=COUNT(p.Id) FROM People p JOIN INSERTED i On i.Email = p.Email WHERE i.Email IS NOT NULL 
 IF @Count &gt; 0  BEGIN RAISERROR ('Cannot put a duplicate email on People table', 16, 1) ROLLBACK TRANSACTION END 
ENDGO
</code></p>

<p>However, Moran Benisty, my T-SQL Ninja pal, has pointed out that the SELECT and IF might bit a wee bit apart, and revised this to</p>

<p>```
CREATE TRIGGER dbo.People_Unique_NonNull_Email ON dbo.People AFTER INSERTAS BEGIN SET NOCOUNT ON</p>

<p>IF EXISTS(SELECT 1 FROM People p JOIN INSERTED i On i.Email = p.Email WHERE i.Email IS NOT NULL  )  BEGIN RAISERROR (‘Cannot put a duplicate email on People table’, 16, 1) ROLLBACK TRANSACTION END </p>

<p>ENDGO
```</p>

<p>I’ll leave adding the UPDATE case to the readers</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/06/22/castle-dot-tools-dot--in-castle-contribs-repository-has-moved-a-bit">Castle.Tools.* in Castle Contrib's repository has moved a bit</a></h2>
    <div class="meta">
        <time>on June 22, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/css" rel="tag">css</a>
            ,&nbsp;
            
            <a href="/blog/tag/html" rel="tag">html</a>
            ,&nbsp;
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/castle" rel="tag">castle</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>The tools (various small helper libraries) are now under <a href="http://svn.castleproject.org:8080/svn/castlecontrib/Tools/">http://svn.castleproject.org:8080/svn/castlecontrib/Tools/</a></p>

<p>what’s in there:
- <a href="http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.StaticMapGenerator/">Castle.Tools.StaticMapGenerator</a> - That one creates a typed tree representing js/css/image files on the site’s filesystem. more here:<a href="http://kenegozi.com/Blog/2008/01/17/staticmapgenerator-for-asp-dot-net-first-teaser.aspx">http://kenegozi.com/Blog/2008/01/17/staticmapgenerator-for-asp-dot-net-first-teaser.aspx</a>Which reminds me that I need to add .swf files to the mix …
- <a href="http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.SQLQueryGenerator/">Castle.Tools.SQLQueryGenerator</a> - That one is for building plain old SQL strings in a typed and intellisense friendly way.more here:<a href="http://kenegozi.com/Blog/2008/01/27/already-added-stuff-to-sql-query-generator.aspx">http://kenegozi.com/Blog/2008/01/27/already-added-stuff-to-sql-query-generator.aspx</a>
- <a href="http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.QuerySpecBuilder/">Castle.Tools.QuerySpecBuilder/</a> - The new kid in the block. That’s a tool that is used to build specs programmatically, which would later be translated to a SQL string for your flavour of DAL. The generated SQL is mostly ANSI compliant, apart from the Paging syntax which is TSQL only currently, but at some point I’ll add an extension point to allow other syntaxes.I also have an external thing to make it extremely useful with NHibernate’s ISQLQuery.I’ll blog about all that when I’ll have a little time.</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/05/30/beware-of-sql-typos">Beware of SQL typos</a></h2>
    <div class="meta">
        <time>on May 30, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>I feel so stupid.</p>

<p>Just spent almost two hours trying to figure out why a SQL query wasn’t running.</p>

<p>I kept getting “Incorrect syntax near ‘RowNumber’” error message.</p>

<p>I was under the impression that my SQL syntax was ok, and tried various changes to the way I was invoking the query, but alas, nothing worked.</p>

<p>Then I just copied the raw query into SQL Manager, just to see the next snippet (the colouring, or lack of, was pointing this out for me):</p>

<p><code>
WEHRE RowNumber BETWEEN @First AND @Last
</code></p>

<p>WEHRE the hell was my head?</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/04/27/wacky-jet-syntax-for-update-from">Wacky JET syntax for UPDATE FROM</a></h2>
    <div class="meta">
        <time>on April 27, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Today I’ve given a little help to a friend, with a JET 4.0 (Ms-ACCESS) thing.</p>

<p>Situation
Given an existing schema:</p>

<p>Customers (Id, Name, …, Email) Ads (CustomerId, …)</p>

<p>the client wanted to add a field name TargetEmail to Ads table.</p>

<p>Adding the field was simple enough:</p>

<p><code>
ALTER TABLE Ads ADD COLUMN TargetEmail TEXT(255)
</code></p>

<p>Now the client wanted to initialise the TargetEmail field for existing ads, based on the Customer’s email.</p>

<p>A Naive and SQL Server jockey as I am, I gave him that little snippet:</p>

<p><code>
UPDATE   Ads SET      Ads.TargetEmail = Customers.EmailFROM     Ads     JOIN Customers ON Ads.CustomerId = Customers.IdWHERE   Ads.TargetEmail IS NULL
</code>
Problem
JET had refused that syntax.</p>

<p>Or rather, Jet is weird.</p>

<p>Solution
Google to the rescue. answer was <a href="http://www.cryer.co.uk/brian/sql/sql_crib_sheet.htm">here</a>.</p>

<p><code>
UPDATE  Ads,         Customers SET     Ads.TargetEmail = Customers.EmailWHERE	Ads.CustomerId = Customers.Id  AND   Ads.TargetEmail IS NULL
</code></p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/01/27/sql-query-generator-first-release">SQL Query Generator - First Release</a></h2>
    <div class="meta">
        <time>on January 27, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>What is it?
A tool that generates a strongly typed representation of a relational database, to be used for generating SQL queries in a type-safe fashion, with the aid of intellisense.</p>

<p>Where to get it?
- Current Binaries: <a href="http://kenegozi.com/Blog/Files/download.aspx?filename=Castle.Tools.SQLQueryGenerator-0.9.0.429-Debug.zip">from here</a>
- Source code: http://svn.castleproject.org:8080/svn/castlecontrib/Castle.Tools.SQLQueryGenerator/trunk/</p>

<p>UPDATE (22/06/2008):The source has slightly moved (to a sub folder):<a href="http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.SQLQueryGenerator/">http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.SQLQueryGenerator/</a></p>

<p>Limitations:
- Currently works only with SQL Server 2005. Patches for more DB types would be welcomed.<br />
- Currently only SELECT queries are implemented. Soon I’ll add support for generating INSERT, UPDATE and DELETE, too.<br />
- GroupBy, Order By and Having clauses didn’t make it to this initial release. I hope to add those this week.</p>

<p>How to use it?- Generating the classes:Run Castle.Tools.SQLQueryGenerator.exe.Parameters:The mandatory flag is /db:DBNAME where DBNAME is your database name. By default, the server being looked for is (local). you can select another using /server:SERVER.By default, Integrated Security is used. You can supply /userid:USER and /password:PASS to override it.You can alternatively supply a /connectionstring:CONSTR parameter.<br />
- Add the generated file, named “SQLQuery.Generated.cs” to your project.<br />
- Add a reference to Castle.Tools.SQLQueryGenerator.Runtime.dll<br />
- Use and Enjoy</p>

<p>Usage sample (from Examples.cs in the test project:</p>

<p><code>
SQLQuery q = SQLQuery .Select(SQL.Blogs.Id, SQL.Blogs.Name) .From(SQL.Blogs);Console.WriteLine(q);
</code></p>

<p>Would print out:</p>

<p><code>
SELECT [dbo].[Blogs].[Id], [dbo].[Blogs].[Name]FROM [dbo].[Blogs]
</code></p>

<p>Not impressed? Well,</p>

<p><code>
dbo_ForumMessages Message = SQL.ForumMessages.As("Message");dbo_ForumMessages Parent = SQL.ForumMessages.As("Parent"); SQLQuery q = SQLQuery .Select(Message.Id, Message.ParentId, Message.Content) .From(Message) .Join(Parent, Message.ParentId == Parent.Id);Console.WriteLine(q);
</code></p>

<p>Will spit out</p>

<p><code>
SELECT [Message].[Id], [Message].[ParentId], [Message].[Content]FROM [dbo].[ForumMessages] AS [Message] JOIN [dbo].[ForumMessages] AS [Parent] ON ([Message].[ParentId] = [Parent].[Id])
</code></p>

<p>Need parameters?</p>

<p><code>
Parameter&lt;int&gt; blogId = new Parameter&lt;int&gt;("BlogId"); SQLQuery q = SQLQuery .Select(SQL.Blogs.Id, SQL.Blogs.Name) .From(SQL.Blogs) .Where(SQL.Blogs.Id == blogId);Console.WriteLine(q);
</code></p>

<p>would echo</p>

<p><code>
SELECT [dbo].[Blogs].[Id], [dbo].[Blogs].[Name]FROM [dbo].[Blogs]WHERE ([dbo].[Blogs].[Id] = @BlogId)
</code></p>

<p>How can YOU help?- Use it. Praise it. Use Paypal. </p>

<ul>
  <li>Or you can suggest improvements, spot bugs, create patches and buy me beer.</li>
</ul>


    </section>


  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/01/27/already-added-stuff-to-sql-query-generator">Already Added Stuff To SQL Query Generator</a></h2>
    <div class="meta">
        <time>on January 27, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>the new stuff:</p>

<ul>
  <li>Reusing clauses  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Operators (</td>
          <td> </td>
          <td>, &amp;&amp;, !) on where clause</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>OrderBy clause</li>
</ul>

<p>Examples:</p>

<p>Reusing clauses:</p>

<p><code>
FromClause from = new FromClause(SQL.Blogs);WhereClause where = new WhereClause(SQL.Blogs.Id == 2); SQLQuery q1 = SQLQuery .Select(SQL.Blogs.Id) .From(from) .Where(where); SQLQuery q2 = SQLQuery .Select(SQL.Blogs.Name) .From(from) .Where(where); Console.WriteLine(q1);Console.WriteLine(q2);
</code></p>

<p>makes</p>

<p><code>
SELECT [dbo].[Blogs].[Id]FROM [dbo].[Blogs]WHERE ([dbo].[Blogs].[Id] = 2)SELECT [dbo].[Blogs].[Name]FROM [dbo].[Blogs]WHERE ([dbo].[Blogs].[Id] = 2)
</code></p>

<p>Operators:</p>

<p><code>
SQLQuery q1 = SQLQuery .Select(SQL.Blogs.Id) .From(SQL.Blogs) .Where(SQL.Blogs.Id &gt; 2 || SQL.Blogs.Name == "Ken");Console.WriteLine(q1);
</code></p>

<p>makes</p>

<p><code>
SELECT [dbo].[Blogs].[Id]FROM [dbo].[Blogs]WHERE (([dbo].[Blogs].[Id] &gt; 2) OR ([dbo].[Blogs].[Name] = N'Ken'))
</code></p>

<p>OrderBy Clause:</p>

<p><code>
SQLQuery q = SQLQuery .Select(SQL.Blogs.Id) .From(SQL.Blogs) .Where(SQL.Blogs.Id &gt; 2) .OrderBy(Order.By(SQL.Blogs.Id), Order.By(SQL.Blogs.Name).Desc);Console.WriteLine(q);
</code></p>

<p>makes</p>

<p><code>
SELECT [dbo].[Blogs].[Id]FROM [dbo].[Blogs]WHERE ([dbo].[Blogs].[Id] &gt; 2)ORDER BY [dbo].[Blogs].[Id], [dbo].[Blogs].[Name] DESC
</code></p>

<p>Didn’t have time to upload a binary, but you can simply grab the source and build yourself. it has absolutely no dependencies but .NET 2.0</p>

<p>Where from?</p>

<p>http://svn.castleproject.org:8080/svn/castlecontrib/Castle.Tools.SQLQueryGenerator/trunk/</p>

<p>UPDATE (22/06/2008):The source has slightly moved (to a sub folder):<a href="http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.SQLQueryGenerator/">http://svn.castleproject.org:8080/svn/castlecontrib/Tools/Castle.Tools.SQLQueryGenerator/</a></p>


    </section>


  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/01/24/cannot-recreate-database-with-asp-dot-net-membership-due-to-collation-problems">Cannot Recreate Database With ASP.NET Membership Due To Collation Problems</a></h2>
    <div class="meta">
        <time>on January 24, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Situation:
- My SQL Server 2005 Express has a default collation of HEBREW_CI_AI
- I have a dev database with Latin_General_CI_AS</p>

<p>Problem:</p>

<p>Trying to rebuild the database from script fails due to collation errors.</p>

<p>Explanation:</p>

<p>A bit of lookup into those using my good pal google, have proved my suspicions. Somewhere along the script a StoredProc is being created, which joins to a temp table. It appear that temp tables are being created within the tempdb system database, which in turn has the collation of the server.</p>

<p>The answer usually is to create temp tables with explicit collation. However, those stored proces are generated by the ASP.NET membership thing, so it cannot be setup to use the proper collation on temp tables.</p>

<p>So, Solution 1 (if it’s not happening on generated stored procs):</p>

<p>Explicitly set the collation on temp tables.</p>

<p>Solution 2 (for the other poor people with generated sprocs):</p>

<p>You’d need to rebuild the system databases, either by reinstalling SQL Server, or following <a href="http://msdn2.microsoft.com/en-us/library/ms144259.aspx">these instructions</a></p>

<p>The list of collation options can be found <a href="http://msdn2.microsoft.com/en-us/library/ms143508.aspx">here</a></p>


    </section>


  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/01/19/sql-query-genrator">SQL Query Generator</a></h2>
    <div class="meta">
        <time>on January 19, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Imagine you could write that in your IDE:</p>

<p><code>
SQLQuery q = SQLQuery .Select(SQL.Blogs.Id, SQL.Blogs.Name) .From(SQL.Blogs) .Join(SQL.Posts, Join.On(SQL.Blogs.Id == SQL.Posts.BlogId)) .Where(SQL.Blogs.Name != "Ken's blog");
Console.WriteLine(q); 
</code></p>

<p>and getting that output :</p>

<p><code>
SELECT [Blogs].[Id], [Blogs].[Name]FROM ([Blogs] JOIN [Posts] ON ([Blogs].[Id]=[Posts].[BlogId]))WHERE ([Blogs].[Name]&lt;&gt;'Ken''s blog') 
</code></p>

<p>Soon enough you would be able to to that.</p>

<p>After having fun creating the Static Sitemap Generator, today I’ve had a little free time (as my main machine is being reinstalled), so I came up with a SQL query generator.</p>

<p>It would be a tool to generate classes out of a database, that would make writing typed sql queries a breeze.</p>

<p>I have most of it working, except the part where I retrieve the metadata from the database … No worries, my good friend and SQL guru Moran is about to send me the queries for that real soon.</p>

<p>First release would work with SQL Server 2005, and later on I’ll add extension points to hook up other db engines.</p>


    </section>


  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2008/01/19/retrieving-all-column-names-and-types-from-sql-server-2005-for--dot-net">Retrieving All Column Names And Types From SQL Server 2005 For .NET</a></h2>
    <div class="meta">
        <time>on January 19, 2008</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Nothing fancy.</p>

<p>With a little help from Moran Benisty, here’s the script I use to get the metadata I need for the <a href="http://kenegozi.com/Blog/2008/01/19/sql-query-genrator.aspx">SQLQueryGenerator</a>:</p>

<p><code>
SELECT schemas.name AS [Schema], tables.name AS [Table], columns.name AS [Column], CASE  WHEN columns.system_type_id = 34 THEN 'byte[]' WHEN columns.system_type_id = 35 THEN 'string' WHEN columns.system_type_id = 36 THEN 'System.Guid' WHEN columns.system_type_id = 48 THEN 'byte' WHEN columns.system_type_id = 52 THEN 'short' WHEN columns.system_type_id = 56 THEN 'int' WHEN columns.system_type_id = 58 THEN 'System.DateTime' WHEN columns.system_type_id = 59 THEN 'float' WHEN columns.system_type_id = 60 THEN 'decimal' WHEN columns.system_type_id = 61 THEN 'System.DateTime' WHEN columns.system_type_id = 62 THEN 'double' WHEN columns.system_type_id = 98 THEN 'object' WHEN columns.system_type_id = 99 THEN 'string' WHEN columns.system_type_id = 104 THEN 'bool' WHEN columns.system_type_id = 106 THEN 'decimal' WHEN columns.system_type_id = 108 THEN 'decimal' WHEN columns.system_type_id = 122 THEN 'decimal' WHEN columns.system_type_id = 127 THEN 'long' WHEN columns.system_type_id = 165 THEN 'byte[]' WHEN columns.system_type_id = 167 THEN 'string' WHEN columns.system_type_id = 173 THEN 'byte[]' WHEN columns.system_type_id = 175 THEN 'string' WHEN columns.system_type_id = 189 THEN 'long' WHEN columns.system_type_id = 231 THEN 'string' WHEN columns.system_type_id = 239 THEN 'string' WHEN columns.system_type_id = 241 THEN 'string' WHEN columns.system_type_id = 241 THEN 'string' END AS [Type], columns.is_nullable AS [Nullable]FROM sys.tables tables INNER JOIN sys.schemas schemas ON (tables.schema_id = schemas.schema_id ) INNER JOIN sys.columns columns ON (columns.object_id = tables.object_id) WHERE tables.name &lt;&gt; 'sysdiagrams'  AND tables.name &lt;&gt; 'dtproperties' 
ORDER BY [Schema], [Table], [Column], [Type]
</code></p>

<p>Quick, Dirty, Working.</p>

<p>Anyone up to contributing a similar thing for SQL 2000 / MySql / Oracle / Postgres / MS-ACCESS ?</p>

<p>it’s going to be subversion-ed really soon.</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2007/10/13/sql-server-2005-cannot-create-database-diagrams-database-does-not-have-a-valid-owner">SQL Server 2005 - Cannot create Database Diagrams - Database does not have a valid owner</a></h2>
    <div class="meta">
        <time>on October 13, 2007</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>Using SQL Server Management Studio (be it the ‘full’ version or the express one), you can sometime encounter the error:</p>

<p><img src="http://kenegozi.com/Blog/uploaded/WindowsLiveWriter/SQLServer2005CannotcreateDatabaseDiagram_123DC/c20f45d1-6118-4b12-845d-1a78e619c256.png" alt="Database has no valid owner" /></p>

<p>in words:</p>

<p>Database diagram support objects cannot be installed because this database does not have a valid owner. To continue, first use the Files page of the Database Properties dialog box or the ALTER AUTHORIZATION statement to set the database owner to a valid login, then add the database diagram support objects. </p>

<p>It usually happens when you’ve created that DB by a script (which was a bit incomplete) or by restoring a DB created on another machine, with some different settings.</p>

<p>Instead of going to the bottom of it, I’ll just write down the simple solution, for future reference.</p>

<p>open a new Query, and run the next stored procedure:</p>

<p><code>
EXEC sp_changedbowner 'sa'
</code></p>

<p>If you have another default owner on your machine, use it’s login instead of ‘sa’.</p>

<p>That’s it.</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    

    <section class="container content post">
    <h2><a href="/blog/2007/05/18/backing-up-a-hosted-sql-server-db">Backing up a hosted SQL Server DB</a></h2>
    <div class="meta">
        <time>on May 18, 2007</time>&nbsp;&nbsp;
        <span class="tags">
            
            <a href="/blog/tag/miscellanea" rel="tag">miscellanea</a>
            ,&nbsp;
            
            <a href="/blog/tag/tools" rel="tag">tools</a>
            ,&nbsp;
            
            <a href="/blog/tag/sql" rel="tag">sql</a>
            
            
        </span>
        
    </div>
    
     <p>As you already have probably noticed by now, I did some renovation on my blog.</p>

<p>Among other things, it is now being served froma SQL Server database, rather than form the daBlog xml files.</p>

<p>One caveat of this, is the fact that backuping the blog’s content became much harder. Since I have no access to db backups, I neede to find a way to generate the INSERT scripts that will enable me recreationg the content if it would be needed.</p>

<p>My first try-out was <a href="http://www.microsoft.com/downloads/details.aspx?FamilyId=56E5B1C5-BF17-42E0-A410-371A838E570A&amp;displaylang=en">the Microsoft SQL Server Database Publishing Wizard</a>, <a href="http://weblogs.asp.net/scottgu/archive/2006/12/22/recipe-deploying-a-sql-database-to-a-remote-hosting-environment-part-1.aspx">that I saw at Scott Gu’s blog</a></p>

<p>This tool is meant to create the script form a local dev db, in order to make it run on the remote one. Actually you can make it run on the remote one, nd save the generated sql file locally, for backup purposes.</p>

<p>I tried it up, but it send some nasty .NET break dialogs.It however managed to create A script, that I’m yet to check for it’s usability.</p>

<p>Nice tool. But I’ll look for something that is pure t-sql so it’d be easier to run (maybe automated every once in a while)</p>


    </section>


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
</section>


	<!-- FOOTER -->
	<footer id="footer" class="section">
		<div class="container">
			<p class="copyright pull-left">
				&copy; 2014. Ken Egozi. All Rights Reserved.
				<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
					<img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
				</a>
				</p>
		</div>
	</footer>
	<!-- END FOOTER -->
	<div class="back-to-top">
		<a href="#top"><i class="fa fa-chevron-up"></i></a>
	</div>

	<script src="/assets/javascripts/jquery-2.1.0.min.js"></script>
	<script src="/assets/javascripts/jquery.localScroll.min.js"></script>
	<script src="/assets/javascripts/looper.min.js"></script>
	<script src="/assets/javascripts/bootstrap.min.js"></script>
	<script src="/assets/javascripts/site.js"></script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-431307-1']);
		_gaq.push(['_setDomainName', '.kenegozi.com']);
		_gaq.push(['_trackPageview']);

		$(function () {
			var src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';

			$.getScript(src);
		});
	</script>
</body>
</html>
